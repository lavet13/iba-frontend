import React, { FC, memo, useRef, useEffect, useState } from 'react';

import {
  ErrorMessage,
  FastField,
  FastFieldProps,
  useFormikContext,
} from 'formik';

import {
  FormControl,
  FormErrorMessage,
  FormLabel,
  Input,
  InputGroup,
  InputProps,
  InputRightElement,
  Icon,
  Flex,
  Image,
} from '@chakra-ui/react';
import { HiOutlinePaperClip, HiX } from 'react-icons/hi';

type FileInputProps = {
  label: string;
  name: string;
  type?: React.HTMLInputTypeAttribute;
  placeholder?: string;
  accept?: string;
  multipleFiles?: boolean;
  id?: string;
} & InputProps;

const MAX_FILE_NAME_LENGTH = 20;

const FileInput: FC<FileInputProps> = memo(
  ({ label, name, accept, multipleFiles = false, ...props }) => {
    const [imagesURI, setImagesURI] = useState<(string | ArrayBuffer | null)[]>(
      []
    );
    const handleOnSave = (e: ProgressEvent<FileReader>) =>
      setImagesURI(images =>
        [...images, e.target ? e.target.result : null].filter(Boolean)
      );

    const inputRef = useRef<HTMLInputElement | null>(null);
    const formik = useFormikContext<any>();
    const value = formik.values?.[name];

    useEffect(() => {
      const isFileExist =
        value?.[0] && typeof value[0] === 'object' && 'name' in value[0];

      if (!isFileExist) {
        formik.setFieldValue(name, null);
      }
    }, [value, name]);

    return (
      <FastField name={name} {...(imagesURI.length !== 0 ? { imagesURI } : {})}>
        {({
          field: { value },
          meta,
          form: { setFieldValue },
        }: FastFieldProps) => {
          const fileName = value?.length
            ? (value as File[])
                .map(({ name }) => getShortFileName(name, MAX_FILE_NAME_LENGTH))
                .join(' & ')
            : '';

          const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
            const fileList = Array.from(e.currentTarget.files || []);
            setFieldValue(name, fileList);

            const reader = new FileReader();
            reader.addEventListener('load', e => {
              handleOnSave(e);
            });

            const getLastFile = Array.from(e.currentTarget.files || []).at(-1)!;
            reader.readAsDataURL(getLastFile);

            clearInnerInput();
          };

          const clearInnerInput = () => {
            if (inputRef.current) {
              inputRef.current.value = '';
            }
          };

          const handleOnClearClick = () => {
            setFieldValue(name, null);
            setImagesURI([]);
            clearInnerInput();
          };

          const handleOnInputClick = () => {
            if (inputRef.current) {
              inputRef.current.value = '';
              inputRef.current.click();
            }
          };

          return (
            <FormControl
              isRequired={props.isRequired}
              isInvalid={!!meta.error && meta.touched}
            >
              <FormLabel id={props.id || name} htmlFor={props.id || name}>
                {label}
              </FormLabel>
              <InputGroup>
                <input
                  type='file'
                  name={name}
                  accept={accept}
                  style={{ display: 'none' }}
                  multiple={multipleFiles}
                  onChange={handleFileChange}
                  ref={inputRef}
                />
                <Input
                  placeholder={props.placeholder}
                  cursor={'pointer'}
                  {...{
                    ...props,
                    readOnly: true,
                    isReadOnly: true,
                    value: fileName,
                    onClick: handleOnInputClick,
                  }}
                />
                {!value?.length ? (
                  <InputRightElement pointerEvents={'none'}>
                    <Icon as={HiOutlinePaperClip} boxSize={5} />
                  </InputRightElement>
                ) : (
                  <InputRightElement
                    onClick={handleOnClearClick}
                    cursor={'pointer'}
                  >
                    <Flex
                      align={'center'}
                      justify={'center'}
                      p={1}
                      rounded={'md'}
                      _hover={{ bg: 'blackAlpha.100' }}
                      _dark={{ _hover: { bg: 'whiteAlpha.100' } }}
                      transitionTimingFunction={'ease-in-out'}
                      transitionDuration={'fast'}
                      transitionProperty='common'
                    >
                      <Icon as={HiX} boxSize={5} />
                    </Flex>
                  </InputRightElement>
                )}
              </InputGroup>
              {imagesURI.length !== 0
                ? imagesURI.map(img => <Image src={img as string} />)
                : null}
              <ErrorMessage name={name} component={FormErrorMessage} />
            </FormControl>
          );
        }}
      </FastField>
    );
  }
);

function getShortFileName(fileName: string, maxLength: number) {
  if (!fileName) return null;
  const lastDotIndex = fileName.lastIndexOf('.');
  const extension = fileName.slice(lastDotIndex);
  const name = fileName.slice(0, lastDotIndex);
  const totalLength = name.length + extension.length + 1;

  if (totalLength <= maxLength) {
    return fileName;
  }

  const maxNameLength = maxLength - extension.length - 6;
  const truncatedName = name.slice(0, maxNameLength);
  const endPart = name.slice(lastDotIndex - 6, lastDotIndex);
  return `${truncatedName}...${endPart}${extension}`;
}

export default FileInput;
